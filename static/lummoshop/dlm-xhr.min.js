jQuery(function(e){new DLM_XHR_Download});class DLM_XHR_Download{constructor(){(dlmXHRinstance=this).init()}init(){dlmXHRinstance.attachButtonEvent()}attachButtonEvent(){let d="",o="";jQuery.each(dlmXHR.xhr_links.class,function(e,t){-1<t.indexOf("[class")||-1<t.indexOf("[id")?d+=o+" "+t:d+=o+" ."+t,o=","}),jQuery("html, body").on("click",d,function(e){return!!jQuery(this).hasClass("dlm-no-xhr-download")||(0<=jQuery(this).attr("href").indexOf("?add-to-cart")||void dlmXHRinstance.handleDownloadClick(this,e))})}handleDownloadClick(e,t){t.stopPropagation();var d=e.getAttribute("href");let o={button:e,href:d,buttonObj:jQuery(e)};-1===o.href.indexOf("blob:http")&&"#"!==o.href&&(t.preventDefault(),dlmXHRinstance.retrieveBlob(o))}retrieveBlob(e){let{button:r,href:n,buttonObj:l}=e,a;const s=new XMLHttpRequest,i=dlmXHR.prevent_duplicates,c=l.attr("target");let m=l.attr("class");m=void 0!==m&&""!==m?m.replace("dlm-download-started","").replace("dlm-download-completed",""):"",l.addClass("dlm-download-started"),r.setAttribute("href","#"),r.removeAttribute("download"),r.setAttribute("disabled","disabled");e=0<n.indexOf("?")?n+"&nonce="+dlmXHR.nonce:n+"?nonce="+dlmXHR.nonce;jQuery(document).trigger("dlm_download_triggered",[this,r,l,a]),s.responseType="blob",s.onreadystatechange=function(){var{status:e,readyState:t,statusText:d}=s;let o=s.getAllResponseHeaders().split("\r\n").reduce((e,t)=>{var[t,d]=t.split(": ");return e[t]=d,e},{});if(2===s.readyState){if(void 0!==o["dlm-no-waypoints"]&&(s.abort(),window.location.href=n),void 0!==o["dlm-external-download"]){s.abort();let e="";return void 0!==o["dlm-file-name"]?(e=o["dlm-file-name"].replace(/\"/g,"").replace(";",""),e=decodeURI(e)):void 0!==o["content-disposition"]&&(e=(e=o["content-disposition"].split("filename=")[1]).replace(/\"/g,"").replace(";",""),e=decodeURI(e)),void dlmXHRinstance.dlmExternalDownload(o,r,l,e,n)}if(0===Object.keys(o).filter(e=>-1!==e.indexOf("dlm-")).length&&(s.abort(),window.location.href=n),void 0!==o["dlm-error"]&&""!==o["dlm-error"]&&null!==o["dlm-error"])return dlmXHRinstance.dlmLogDownload(o,"failed",!1),r.removeAttribute("download"),r.setAttribute("href",n),l.removeClass().addClass(m).find("span.dlm-xhr-progress").remove(),s.abort(),void l.append('<span class="dlm-xhr-error">'+o["dlm-error"]+"</span>");if(void 0!==o["dlm-redirect"]&&""!==o["dlm-redirect"]&&null!==o["dlm-redirect"])return dlmXHRinstance.dlmLogDownload(o,"redirected",!1,o["dlm-redirect"],o["dlm-no-access"],c),r.removeAttribute("download"),r.setAttribute("href",n),l.removeClass().addClass(m).find("span.dlm-xhr-progress").remove(),void s.abort()}if(404==e&&2==t){let e=document.createElement("p");e.innerHTML=d,r.parentNode.appendChild(e)}if(401==e&&2==t&&(window.location.href=d),403==e&&2==t){let e=document.createElement("p");e.innerHTML=d,r.parentNode.appendChild(e)}if(200==e&&4==t){d=s.response;let e=o["content-disposition"].split("filename=")[1];e=e.replace(/\"/g,"").replace(";",""),e=decodeURI(e),a=URL.createObjectURL(d),r.removeEventListener("click",dlmXHRinstance.handleDownloadClick),r.setAttribute("download",""+e),r.setAttribute("href",a),r.click(),l.removeClass().addClass(m+" dlm-download-complete"),dlmXHRinstance.attachButtonEvent(),jQuery(document).trigger("dlm_download_complete",[this,r,l,a]),dlmXHRinstance.dlmLogDownload(o,"completed",i),window.URL.revokeObjectURL(a),r.removeAttribute("download"),r.setAttribute("href",n),setTimeout(function(){l.removeClass().addClass(m).find("span.dlm-xhr-progress").remove()},4e3)}},s.addEventListener("progress",function(e){let t=e.loaded/e.total*100;t=t.toFixed(2);var d;l.find("span.dlm-xhr-progress").remove(),d="dlm-download-started download-"+10*Math.ceil(t/10),1/0!=t&&l.append('<span class="dlm-xhr-progress">&nbsp;'+t+"%</span>"),l.removeClass().addClass(m+" "+d),jQuery(document).trigger("dlm_download_progress",[this,r,l,a,e,t])}),s.onerror=function(){r.removeAttribute("download"),r.setAttribute("href",n),l.removeClass().addClass(m+" dlm-no-xhr-download").find("span.dlm-xhr-progress").remove(),l.append('<span class="dlm-xhr-error">'+dlmXHRtranslations.error+"</span>"),console.log("** An error occurred during the transaction")},s.open("GET",e,!0),s.setRequestHeader("dlm-xhr-request","dlm_XMLHttpRequest"),s.send()}dlmLogDownload(e,t,d,o=null,r=null,n="_self"){null!==r?window.location.href=o:(r=window.location.href,t={download_id:e["dlm-download-id"],version_id:e["dlm-version-id"],status:t,cookie:d,currentURL:r,action:"log_dlm_xhr_download",responseHeaders:e,nonce:dlmXHR.nonce},jQuery.post(dlmXHR.ajaxUrl,t,function(e){null!==o&&(null==n&&(n="_self"),window.open(o,n))}))}dlmExternalDownload(e,o,r,n,l){const a=new XMLHttpRequest,t=e["dlm-external-download"];r.attr("target");let s=r.attr("class"),i;s=void 0!==s&&""!==s?s.replace("dlm-download-started","").replace("dlm-download-completed",""):"",r.addClass("dlm-download-started"),o.setAttribute("href","#"),o.removeAttribute("download"),o.setAttribute("disabled","disabled"),jQuery(document).trigger("dlm_download_triggered",[this,o,r,i]),a.responseType="blob",a.onreadystatechange=function(){var{status:e,readyState:t}=a,d=a.getAllResponseHeaders().split("\r\n").reduce((e,t)=>{var[t,d]=t.split(": ");return e[t]=d,e},{});if(403===e)return dlmXHRinstance.dlmLogDownload(d,"failed",!1),a.abort(),void r.append('<span class="dlm-xhr-error">Acces Denied to file.</span>');200==e&&4==t&&(e=a.response,i=URL.createObjectURL(e),o.removeEventListener("click",dlmXHRinstance.handleDownloadClick),o.setAttribute("download",""+n),o.setAttribute("href",i),o.click(),r.removeClass().addClass(s+" dlm-download-complete"),dlmXHRinstance.attachButtonEvent(),jQuery(document).trigger("dlm_download_complete",[this,o,r,i]),dlmXHRinstance.dlmLogDownload(d,"completed",!1),window.URL.revokeObjectURL(i),o.removeAttribute("download"),o.setAttribute("href",l),setTimeout(function(){r.removeClass().addClass(s).find("span.dlm-xhr-progress").remove()},1e3))},a.addEventListener("progress",function(e){let t=e.loaded/e.total*100;t=t.toFixed(2);var d;r.find("span.dlm-xhr-progress").remove(),d="dlm-download-started download-"+10*Math.ceil(t/10),1/0!=t&&r.append('<span class="dlm-xhr-progress">&nbsp;'+t+"%</span>"),r.removeClass().addClass(s+" "+d),jQuery(document).trigger("dlm_download_progress",[this,o,r,i,e,t])}),a.onerror=function(){o.removeAttribute("download"),o.setAttribute("href",l),r.removeClass().addClass(s+" .dlm-no-xhr-download").find("span.dlm-xhr-progress").remove(),r.append('<span class="dlm-xhr-error">'+dlmXHRtranslations.error+"</span>"),console.log("** An error occurred during the transaction")},a.open("GET",t,!0),a.setRequestHeader("dlm-xhr-request","dlm_XMLHttpRequest"),a.send()}}